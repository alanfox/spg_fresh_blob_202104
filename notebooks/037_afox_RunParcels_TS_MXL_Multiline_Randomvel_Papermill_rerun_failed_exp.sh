#!/usr/bin/env bash
#SBATCH --job-name=037_afox_1990-2019_rerun
#SBATCH --ntasks=164
#SBATCH --cpus-per-task=1
#SBATCH --mem-per-cpu=35G
#SBATCH --time=34:00:00
#SBATCH --partition=cluster
#SBATCH --mail-user=chschmidt@geomar.de
#SBATCH --mail-type=ALL

module load singularity/3.5.2 

for date in '2009-11-14' '2013-12-29' '2000-04-03' '2019-11-24' '1992-05-18' '2008-07-02' '2012-10-15' '1992-07-02' '1997-02-07' '2014-06-07' '1996-02-28' '2012-09-25' '2019-01-28' '2008-03-29' '1993-02-12' '1992-05-28' '2009-06-07' '2001-10-30' '2019-05-13' '2004-06-27' '2004-09-20' '2008-08-26' '2009-06-02' '1998-06-17' '2012-03-09' '2004-06-22' '1997-05-23' '1993-02-28' '2008-04-28' '2000-09-20' '2000-03-09' '2012-09-15' '2005-08-06' '2005-07-22' '2012-11-09' '1993-02-22' '2000-05-13' '2017-02-22' '2017-07-22' '2011-10-05' '2005-07-27' '2006-05-23' '1997-02-28' '2012-10-10' '2005-05-28' '1997-06-22' '2012-07-07' '2018-04-13' '2000-04-28' '1997-09-05' '2013-05-23' '2006-04-13' '2019-02-28' '2019-07-17' '2019-11-04' '1992-06-07' '2010-07-02' '2003-08-06' '2018-04-23' '2019-05-28' '2000-12-24' '2000-03-14' '1993-07-22' '2019-03-29' '2003-05-18' '2012-07-12' '1992-09-05' '1996-06-12' '2016-08-21' '1996-11-29' '1998-03-29' '2000-10-20' '2019-07-02' '2012-03-04' '2016-05-18' '2000-05-18' '2000-07-22' '2008-06-12' '2004-04-13' '1996-06-17' '1990-05-18' '2017-08-06' '2008-05-23' '2016-11-14' '2010-07-07' '2005-09-05' '2013-03-09' '2016-07-27' '1993-09-25' '2016-12-14' '1998-09-10' '2019-08-06' '2017-04-03' '2009-08-01' '1997-01-18' '1992-06-12' '1996-07-07' '1993-10-25' '2001-04-23' '1994-03-19' '1998-02-28' '2010-12-04' '2012-10-30' '2010-06-17' '1999-02-22' '2004-09-15' '1996-08-26' '2005-09-15' '2011-09-25' '1991-02-07' '2005-11-29' '2019-04-18' '2003-08-21' '2016-04-13' '2016-03-24' '2013-08-06' '1996-05-18' '2009-04-08' '2017-07-27' '1997-11-04' '2017-04-23' '1995-11-24' '2008-03-19' '2016-08-01' '2013-08-31' '2000-08-31' '2008-02-28' '2010-05-13' '2000-10-25' '1995-10-05' '1996-04-28' '2013-12-09' '2013-01-23' '2000-08-21' '1996-09-25' '1990-02-12' '2005-06-07' '1997-08-16' '1993-05-23' '2019-06-22' '2004-03-24' '1997-11-09' '1996-07-12' '2001-06-22' '2014-10-10' '2006-05-18' '2018-04-03' '1996-03-09' '1996-03-14' '2016-04-08' '2012-04-13' '2012-09-10' '2012-03-19' '1992-09-30' '2019-02-17' '2008-07-07' '2005-11-24' '2000-05-23' '2019-10-10' '2004-07-07' '2016-07-02' '2008-03-04' '2019-06-17' '2008-08-21'; do
    sleep 0.3  # spread out a little to avoid a bug resulting from a race
               # condition for an unused port
               # see https://github.com/jupyter/jupyter_client/issues/487

    srun --ntasks=1 --exclusive singularity run -B /sfs -B /gxfs_work1 -B $PWD:/work --pwd /work \
        containers/parcels-container_2021.03.17-6c459b7.sif bash -c \
            "cd notebooks; . /opt/conda/etc/profile.d/conda.sh && conda activate base && papermill 037_afox_RunParcels_TS_MXL_Multiline_Randomvel_Papermill.ipynb executed/037_afox_RunParcels_TS_MXL_Multiline_Randomvel_Papermill_executed_${date}.ipynb -k python -p path_name /gxfs_work1/geomar/smomw355/model_data/ocean-only/VIKING20X.L46-KKG36107B/nemo/output/ -p data_resolution 5d -p w_name_extension '' -p mask_path_name /gxfs_work1/geomar/smomw355/model_data/ocean-only/VIKING20X.L46-KKG36107B/nemo/suppl/ -p mesh_mask_filename 1_mesh_mask.nc -p year_prefix '' -p runtime_in_days 3650 -p create_number_particles 4000000 -p use_number_particles 4000000 -p max_release_depth 1000 -p max_current 2.0 -p t_0_str '1980-01-03T12:00:00' -p t_start_str '${date}T12:00:00' -p use_dask_chunks False" &
done

wait

jobinfo
